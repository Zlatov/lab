<!DOCTYPE html>
<html lang="ru">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>MySQL basic knowledge</title>

		<!-- Bootstrap CSS -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

		<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
		<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
		<!--[if lt IE 9]>
			<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.2/html5shiv.min.js"></script>
			<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
		<![endif]-->
	</head>
	<body>
		<div class="container">
			<div class="row">
				<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
					<h1 class="text-center">MySQL basic knowledge</h1>
					<div id="toc"></div>
					<h2>Типы данных</h2>
					<h3>INT</h3>
					<p><code>INT(11)</code> — сколько знаков будет при заполнении нулями (UNSIGNED). Если поле не UNSIGNED, то число ни на что не влияет, только доставляет неудобства при работе с внешними ключами. Диапазон со знаком от -2147483648 до 2147483647. Диапазон без знака от 0 до 4294967295.</p>
					<h3>SMALLINT</h3>
					<p>Диапазон со знаком от -32768 до 32767. Диапазон без знака от 0 до 65535.</p>
					<h3>TINYINT</h3>
					<p>Диапазон со знаком от -128 до 127. Диапазон без знака от 0 до 255.</p>
					<h3>DECIMAL</h3>
					<p>DECIMAL(m,n) — лучшее для хранения цен.</p>
					<h3>ENUM</h3>
					<p>— принимает значение из списка допустимых*. ENUM("один", "два", "три").</p>
					<p>* — может принимать значение пустой строки если при INSERT было указано неверное. Если нет <code>NOT NULL</code>, то так же может принимать и NULL.</p>
					<p>Можно сравнивать по номеру а не по значению <code>SELECT * FROM tbl_name WHERE enum_col=1</code> то же самое что и <code>SELECT * FROM tbl_name WHERE enum_col='один'</code>. Нумерация от 1, неверное значение (пустая строка) принимает номер 0, а NULL соответственно NULL.</p>
					<h3>SET</h3>
					<p>Подобие много ко многим бес смежной таблицы: <code>SET("один", "два") NOT NULL</code> — поле может принимать значения "", "один", "два" и "один,два". Максимум 64 различных элемента.</p>
					<h2>Параметры</h2>
					<h3>Просмотр какого ибо параметра</h3>
					<pre>SHOW VARIABLES LIKE 'sql_safe_updates'</pre>
					<h3>Для удаления связных данны</h3>
					<p><code>SET AUTOCOMMIT = 0; SET FOREIGN_KEY_CHECKS = 0; SET UNIQUE_CHECKS = 0;</code></p>
					<p><code>truncate `table`;</code> или другое удаление.</p>
					<p><code>SET AUTOCOMMIT = 1; SET FOREIGN_KEY_CHECKS = 1; SET UNIQUE_CHECKS = 1;</code></p>
					<h3>Для удаления всей таблицы</h3>
					<pre>SET SQL_SAFE_UPDATES = 0;</pre>
					<h2>Функции и Операторы</h2>
					<h3>COALESCE</h3>
					<p>Возвращает первый в списке элемент со значением, не равным NULL: <code>SELECT COALESCE(NULL,2,NULL,1) -> 2;</code></p>
					<h3>LAST_INSERT_ID()</h3>
					<p>Возвращает последний вставленный id</p>
					<h3>Работа со строками</h3>
					<h4>CHAR_LENGTH</h4>
					<p><code>integer CHAR_LENGTH(str string)</code>возвращают длину строки. Поддерживает многобайтовые символы.</p>
					<h3>if ifnull nullif</h3>
					<h4>if</h4>
					<p><code>IF(expr1,expr2,expr3)</code>. Если expr1 равно значению ИСТИНА (expr1 &lt;&gt; 0 и expr1 &lt;&gt; NULL), то функция IF() возвращает expr2, в противном случае - expr3.</p>
<pre class="prettyprint lang-sql">
	where
		`p`.`price` &gt;= param_from
		and `p`.`price` &lt;= param_to
		and if(param_dishtype &lt;&gt; 0, `d`.`dishtype_id` = param_dishtype, 1)
</pre>
					<h4>ifnull</h4>
					<p><code>IFNULL(expr1,expr2)</code>. Если expr1 не равно NULL, то функция IFNULL() возвращает значение expr1, в противном случае - expr2.</p>
<pre class="prettyprint lang-sql">
	where
		`p`.`price` &gt;= param_from
		and `p`.`price` &lt;= param_to
		and ifnull(`d`.`dishtype_id` = param_dishtype, 1)
</pre>
					<h4>nullif</h4>
					<p><code>NULLIF(expr1,expr2)</code>. Если выражение expr1 = expr2 истинно, то возвращает NULL, в противном случае - expr1.</p>
					<h2>Console</h2>
					<pre>mysql --host=localhost --port=3306 --database=webhobru_yii --user=root --password --execute="select * from user"</pre>
					<pre>mysql -hlocalhost -P3306 -Dwebhobru_yii -uroot -p -e "select * from user"</pre>
					<pre>mysql -uroot -p -e "show databases"</pre>
					<pre>mysql -uroot --password="" -Dwebhobru_yii -e "call buy_list(1)"</pre>
					<h2>Примеры процедур ага</h2>
<pre class="prettyprint lang-sql">
use `food`;
drop procedure if exists `cook_menu_all`;
drop procedure if exists `current_menu`;
drop procedure if exists `cook_kitchens`;
drop procedure if exists `product_filters`;
drop procedure if exists `search_dish`;
drop procedure if exists `search_cook`;
delimiter ;;

create procedure `cook_menu_all`(in param_user_id int(11))
begin
	select *
	from product p 
	left join dish d
		on d.product_id = p.id
	left join `set` s
		on s.product_id = p.id
	left join `set_dish` sd
		on sd.set_id = s.product_id
	left join `dish` dd
		on dd.product_id = sd.dish_id
	left join `dish_kitchen` dk
		on dk.dish_id = d.product_id
	left join `dish_kitchen` dks
		on dks.dish_id = dd.product_id
	where p.user_id = param_user_id
	group by p.id;
end;;

create procedure `current_menu`(in param_sid varchar(80))
begin
	(
	select
		`c`.`id`,
		`c`.`pid`,
		`c`.`sid`,
		`c`.`header`,
		`c`.`order`
	from
		`page` `p`
	left join
		`page` `r` on `r`.`id` = `p`.`pid`
	left join
		`page` `c` on if(`r`.`id`, `c`.`pid` = `r`.`id`, `c`.`pid` is null)
	where
		`p`.`sid` = param_sid
	)
	union all
	(
	select
		`c2`.`id`,
		`c2`.`pid`,
		`c2`.`sid`,
		`c2`.`header`,
		`c2`.`order`
	from
		`page` `p`
	left join
		`page` `r` on `r`.`id` = `p`.`pid`
	left join
		`page` `c` on if(`r`.`id`, `c`.`pid` = `r`.`id`, `c`.`pid` is null)
	inner join
		`page` `c2` on `c2`.`pid` = `c`.`id`
	where
		`p`.`sid` = param_sid
	)
	order by
		`order` asc,
		`id` asc;
end ;;

create procedure `cook_kitchens`(in param_user_id int(11))
begin
	select
		distinct k.kitchen_id as id,
		kh.header as header
	from food.product p
	left join dish d on d.product_id = p.id
	left join dish_kitchen k on k.dish_id = d.product_id
	left join kitchen kh on kh.id = k.kitchen_id
	where p.user_id = param_user_id;
end;;

create procedure `product_filters`()
begin
	select
		min(`p`.`pricesale`) as `price_min`,
		max(`p`.`price`) as `price_max`
	from
		`product` `p`;
end;;

create procedure `search_dish`(
	in param_offset int,
	in param_rows int,
	in param_dishordiet varchar(255),
	in param_from decimal(8,2),
	in param_to decimal(8,2),
	in param_dishtype int,
	in param_kitchen varchar(180),
	in param_q varchar(32),
	in param_pickup int,
	in param_workhome int,
	in param_costdeliveryfrom decimal(8,2),
	in param_costdeliveryto decimal(8,2)
)
begin
	select SQL_CALC_FOUND_ROWS
		`p`.`id`
	from
		`product` `p`
		left join `dish` `d` on `d`.`product_id` = `p`.`id`
		left join `diet` `di` on `di`.`id` = `d`.`diet_id`
		left join `dish_kitchen` `dk` on `dk`.`dish_id` = `d`.`product_id`
		left join `kitchen` `k` on `k`.`id` = `dk`.`kitchen_id`
		left join `user` `u` on `u`.`id` = `p`.`user_id`
		left join `profile_cook` `pc` on `pc`.`user_id` = `u`.`id`
	where
		case
			when param_dishordiet = 'dish' then `d`.`diet_id` is null
			when param_dishordiet = 'diet' then `d`.`diet_id` is not null
			else 1 end
		and `p`.`price` &gt;= param_from
		and `p`.`price` &lt;= param_to
		and ifnull(`d`.`dishtype_id` = param_dishtype, 1)
		and
			case
				when param_dishordiet = 'dish' then ifnull(`k`.`sid` = param_kitchen, 1)
				when param_dishordiet = 'diet' then ifnull(`di`.`sid` = param_kitchen, 1)
			end
		and if(param_q=param_q, `p`.`header` like concat('%',param_q,'%'), 1)
		and ifnull(`pc`.`pickup` = param_pickup, 1)
		and if(param_workhome is not null, `pc`.`workhome` = 1, 1)
		and ifnull(`pc`.`costdelivery` &gt;= param_costdeliveryfrom, 1)
		and ifnull(`pc`.`costdelivery` &lt;= param_costdeliveryto, 1)
		and if(param_costdeliveryfrom is not null or param_costdeliveryto is not null, `pc`.`costdelivery` is not null, 1)
		and `u`.`usertype` = 'cook'
		and `u`.`role` = 10
		and `u`.`status` = 10
	group by `p`.`id`
	limit param_offset, param_rows;
end;;

create procedure `search_cook`(
	in param_offset int,
	in param_rows int,
	in param_dishordiet varchar(255),
	in param_from decimal(8,2),
	in param_to decimal(8,2),
	in param_dishtype int,
	in param_kitchen varchar(180),
	in param_q varchar(32),
	in param_pickup int,
	in param_workhome int,
	in param_costdeliveryfrom decimal(8,2),
	in param_costdeliveryto decimal(8,2)
)
begin
	select SQL_CALC_FOUND_ROWS
		`u`.`id` as `u_id`,
		GROUP_CONCAT(DISTINCT `p`.`id` SEPARATOR ',') AS `p_id`
	from
		`user` `u`
		left join `product` `p` on `p`.`user_id` = `u`.`id`
		left join `dish` `d` on `d`.`product_id` = `p`.`id`
		left join `diet` `di` on `di`.`id` = `d`.`diet_id`
		left join `dish_kitchen` `dk` on `dk`.`dish_id` = `d`.`product_id`
		left join `kitchen` `k` on `k`.`id` = `dk`.`kitchen_id`
		left join `profile_cook` `pc` on `pc`.`user_id` = `u`.`id`
	where
		`u`.`usertype` = 'cook'
		and `u`.`role` = 10
		and `u`.`status` = 10
		and
			case
				when param_dishordiet = 'dish' then `d`.`diet_id` is null
				when param_dishordiet = 'diet' then `d`.`diet_id` is not null
				else 1
			end
		and `p`.`price` &gt;= param_from
		and `p`.`price` &lt;= param_to
		and ifnull(`d`.`dishtype_id` = param_dishtype, 1)
		and
			case
				when param_dishordiet = 'dish' then ifnull(`k`.`sid` = param_kitchen, 1)
				when param_dishordiet = 'diet' then ifnull(`di`.`sid` = param_kitchen, 1)
			end
		and if(param_q=param_q, `p`.`header` like concat('%',param_q,'%'), 1)
		and ifnull(`pc`.`pickup` = param_pickup, 1)
		and if(param_workhome is not null, `pc`.`workhome` = 1, 1)
		and ifnull(`pc`.`costdelivery` &gt;= param_costdeliveryfrom, 1)
		and ifnull(`pc`.`costdelivery` &lt;= param_costdeliveryto, 1)
		and if(param_costdeliveryfrom is not null or param_costdeliveryto is not null, `pc`.`costdelivery` is not null, 1)
	group by `u`.`id`
	limit param_offset, param_rows;
end;;
</pre>
				</div>
			</div>
		</div>
		<!-- jQuery -->
		<script src="//code.jquery.com/jquery.js"></script>
		<!-- Bootstrap JavaScript -->
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
		<!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
 		<script src="IE10 viewport hack for Surface"></script>
        <!-- Подсветка синтаксиса кода -->
        <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>
		<script type="text/javascript">
			$(document).ready(function(){
				$("#toc").append('<p>Содержание:</p>');
				$("#toc").append('<ul></ul>');
				$("h2").each(function(i) {
					var current = $(this);
					current.attr("id", "h2" + i);
					$("#toc").children("ul").append("<li><a id='linkh2" + i + "' href='#h2" +
						i + "' title='" + current.attr("tagName") + "'>" +
						current.html() + "</a><ul></ul></li>");
				});
				$("h3").each(function(i) {
					var current = $(this);
					current.attr("id", "h3" + i);
					var prevh2 = current.prevAll("h2").first();
					var j = prevh2.attr("id").substring(2);
					$("#linkh2"+j).next("ul").append("<li><a id='linkh3" + i + "' href='#h3" +
						i + "' title='" + current.attr("tagName") + "'>" +
						current.html() + "</a><ul></ul></li>");
				});
				$("h4").each(function(i) {
					var current = $(this);
					current.attr("id", "h4" + i);
					var prevh3 = current.prevAll("h3").first();
					var j = prevh3.attr("id").substring(2);
					alert
					$("#linkh3"+j).next("ul").append("<li><a id='linkh4" + i + "' href='#h4" +
						i + "' title='" + current.attr("tagName") + "'>" +
						current.html() + "</a><ul></ul></li>");
				});
				$("h5").each(function(i) {
					var current = $(this);
					current.attr("id", "h5" + i);
					var prevh4 = current.prevAll("h4").first();
					var j = prevh4.attr("id").substring(2);
					$("#linkh4"+j).next("ul").append("<li><a id='linkh5" + i + "' href='#h5" +
						i + "' title='" + current.attr("tagName") + "'>" +
						current.html() + "</a><ul></ul></li>");
				});
				$("h6").each(function(i) {
					var current = $(this);
					current.attr("id", "h6" + i);
					var prevh5 = current.prevAll("h5").first();
					var j = prevh5.attr("id").substring(2);
					$("#linkh5"+j).next("ul").append("<li><a id='linkh6" + i + "' href='#h6" +
						i + "' title='" + current.attr("tagName") + "'>" +
						current.html() + "</a><ul></ul></li>");
				});
			});
		</script>
	</body>
</html>