<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Yii2</title>
    <!-- Favicon -->
    <link rel="shortcut icon" href="../favicon.ico" type="image/x-icon">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" type="text/css" href="../theme/bootstrap/css/bootstrap.css">
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.2/html5shiv.min.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->
    <!-- TOC -->
    <link rel="stylesheet" type="text/css" href="../theme/toc/css/css.css">
</head>

<body data-spy="scroll" data-target="#toc">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <h1 class="text-center">Yii2 all</h1>
            </div>
        </div>
        <div class="row">
            <div class="hidden-xs col-sm-4 col-md-4 col-lg-4">
                <div id="toc" data-spy="affix" data-offset-top="0" data-offset-bottom="0"></div>
            </div>
            <div class="col-xs-12 col-sm-8 col-md-8 col-lg-8">
                <h2>Config</h2>
                <h3>Dev or Prod</h3>
                <p>In <code>web/index.php</code>:</p>
                <pre class="prettyprint lang-php">
/*
defined('YII_DEBUG') or define('YII_DEBUG', true);
defined('YII_ENV') or define('YII_ENV', 'dev');
*/

defined('YII_DEBUG') or define('YII_DEBUG', false);
defined('YII_ENV') or define('YII_ENV', 'prod');
</pre>
                <p>These changes affect the type of error.</p>
                <h3>Rules</h3>
                <pre class="prettyprint lang-php">
            [['file'], 'required', 'on' => ['create','createfotos']],
            [['file'], 'safe', 'on' => ['update']],
            [['file'], 'file', 'skipOnEmpty' => false, 'extensions' => 'png, jpg', 'on' => ['create']],
            [['file'], 'file', 'skipOnEmpty' => false, 'extensions' => 'png, jpg', 'maxFiles' => 10, 'on' => ['createfotos']],

            [['file'], 'file', 
                'skipOnEmpty' => true, 
                'extensions' => 'png, jpg', 
                'maxSize' => 9*1024*1024, 
                'mimeTypes' => 'image/jpeg, image/png',
            ],
            [['del_img'], 'boolean'],

            ['status', 'default', 'value' => self::STATUS_ACTIVE],
            ['status', 'in', 'range' => [self::STATUS_ACTIVE, self::STATUS_DELETED]],
            [['updated_at', 'created_at'], 'safe'],
            [['sid', 'header'], 'string', 'max' => 160],

            [['callfrom', 'callto'], 'string', 'max' => 4],
            [['callfrom'],'default','value'=>'0000'],
            [['callto'],'default','value'=>'2359'],

            [['order'], 'default', 'value'=>'100','when'=> function($model){ return $model->isNewRecord; }],
            [['order'], 'integer', 'min' => 0, 'max' => 65535,],



            ['username', 'filter', 'filter' =&gt; 'trim'],
            ['username', 'required'],
            ['username', 'unique', 'targetClass' =&gt; '\common\models\User', 'message' =&gt; 'Это имя пользователя уже занято.', 'on' =&gt; ['create']],
            ['username', 'string', 'min' =&gt; 6, 'max' =&gt; 35],

            ['email', 'filter', 'filter' =&gt; 'trim'],
            ['email', 'required'],
            ['email', 'email'],
            ['email', 'string', 'max' =&gt; 255],
            ['email', 'unique', 'targetClass' =&gt; '\common\models\User', 'message' =&gt; 'Этот адрес электронной почты уже используется.', 'on' =&gt; ['create']],

            // ['password', 'required'],
            // ['password', 'string', 'min' =&gt; 6],

            ['newpassword', 'required', 'on' =&gt; ['create']],
            ['newpassword', 'string', 'on' =&gt; ['create'], 'min' =&gt; 8, 'skipOnEmpty' =&gt; false],
            // ['newpasswordrepeat', 'compare', 'on' =&gt; ['create'], 'compareAttribute' =&gt; 'newpassword'],

            ['newpassword', 'safe', 'on' =&gt; ['update']],
            ['newpassword', 'string', 'on' =&gt; ['update'], 'min' =&gt; 8, 'skipOnEmpty' =&gt; true],
            // ['newpasswordrepeat', 'compare', 'on' =&gt; ['update'], 'compareAttribute' =&gt; 'newpassword'],

            ['newpasswordrepeat', 'compare', 'compareAttribute' =&gt; 'newpassword'],

            ['usertype', 'required'],
            ['usertype', 'in', 'range' =&gt; [User::TYPE_COOK, User::TYPE_USER]],

            ['status', 'required'],
            ['status', 'in', 'range' =&gt; [User::STATUS_DELETED, User::STATUS_ACTIVE]],

            ['role', 'required'],
            ['role', 'in', 'range' =&gt; [User::ROLE_USER, User::ROLE_ADMIN]],
            

            ['kitchens', 'each', 'rule' =&gt; ['string']],
            ['kitchens', 'each', 'rule' =&gt; [
                    'exist',
                    'skipOnError' =&gt; false,
                    'targetClass' =&gt; Kitchen::className(),
                    'targetAttribute' =&gt; 'header',
                    'message' =&gt; 'Кухни с таким наименованием не найдено.',
                ]
            ],
</pre>
                <p>Модель может использоваться в нескольких контроллерах... - Модель использует свойство [[yii\base\Model::scenario]], чтобы отслеживать сценарий, в котором она используется. По умолчанию, модель поддерживает только один сценарий с именем default. В следующем коде показано два способа установки сценария модели:</p>
                <pre class="prettyprint lang-php">
// сценарий задается как свойство
$model = new User;
$model->scenario = User::SCENARIO_LOGIN;

// сценарий задается через конфигурацию
$model = new User(['scenario' => User::SCENARIO_LOGIN]);
</pre>
                <h3>Mailer</h3>
                <p><code>config/main.php</code></p>
                <pre class="prettyprint lang-php">
        'mailer' => [
            'class' => 'yii\swiftmailer\Mailer',
            'viewPath' => '@frontend/mail',
            'useFileTransport' => false,//set this property to false to send mails to real email addresses
            //comment the following array to send mail using php's mail function
            'transport' => [
                'class' => 'Swift_SmtpTransport',
                'host' => 'smtp.gmail.com',
                'username' => 'yourAccauntMail@gmail.com',
                'password' => 'yuorAccauntPassword',
                'port' => '587',
                // 'port' => '465', // с оффициальной страницы, ага.
                'encryption' => 'tls',
            ],
        ],
</pre>
                <h4>Errors</h4>
                <p><code>Expected response code 250 but got code "535", with message "535-5.7.8 Username and Password not accepted.</code></p>
                <p>You need to authorize the external application use of gmail, I think.</p>
                <p>Follow the next steps and authorize to make it:</p>
                <ul>
                    <li>First, go to your Google Account Management page</li>
                    <li>Under the Security options, click Edit link of Authorizing applications &amp; sites</li>
                </ul>
                <h2>Model</h2>
                <h3>ActiveRecors</h3>
                <h4>link()</h4>
                <pre class="prettyprint lang-php">
// Delete all relations in this model User:
$user->unlinkAll('kitchen', true); // HasMany function in model User: getKitchen()
// The secon option force the delete row from the binding table

// Add relation to model Kitchen:
$kitchen->link('users', $user); // HasMany function in model Kitchen: getUsers()
</pre>
                <h4>show ActiveRecord query</h4>
                <pre class="prettyprint lang-php">
$query = Message::find()
    -&gt;with(['author'])
    -&gt;where(['or', ['and', 'author_id =' . $user-&gt;id,'recipient_id =' . $messagesLast[0]-&gt;author_id], ['and', 'author_id =' . $messagesLast[0]-&gt;author_id,'recipient_id =' . $user-&gt;id]])
    -&gt;orderBy('message.created_at asc');
echo &quot;&lt;pre&gt;&quot;;
print_r($query-&gt;createCommand()-&gt;sql);
print_r($query-&gt;createCommand()-&gt;getRawSql());
echo &quot;&lt;/pre&gt;&quot;;
die();
</pre>
                <h4>ActiveRecord queries</h4>
                <pre class="prettyprint lang-php">
    return Kitchen::find()
        -&gt;select('kitchen.*')
        -&gt;innerJoin('dish_kitchen dk', 'dk.kitchen_id = kitchen.id')
        -&gt;innerJoin('dish d', 'd.product_id = dk.dish_id')
        -&gt;innerJoin('product p', 'p.id = d.product_id')
        -&gt;where(['p.user_id' =&gt; $this-&gt;id])
        -&gt;groupBy('kitchen.id')
        -&gt;all();
</pre>
                <h4>Code and queries with Pagination</h4>
                <pre class="prettyprint lang-php">
        $limit = 10;
        $page = (is_null(Yii::$app-&gt;request-&gt;get('page')))?1:Yii::$app-&gt;request-&gt;get('page');
        $offset = ((int)$page-1)*$limit;

        $order = ['created_at' =&gt; SORT_DESC,'id' =&gt; SORT_DESC];

        $blogs = Publication::find()
            -&gt;orderBy($order)
            -&gt;offset($offset)
            -&gt;limit($limit)
            -&gt;all();

        $pagination = new Pagination([
            'totalCount' =&gt; Publication::find()-&gt;count(), 
            'pageSize' =&gt; $limit,
        ]);

        $pagination-&gt;pageSizeParam = false;
</pre>
                <h4>deleteAll</h4>
                <pre class="prettyprint lang-php">
Foto::deleteAll(['album_id' => $this->id]); // Не перебирает модели (не выполняет $model->delete, соответственно beforeDelete() и... тоже)
</pre>
                <h3>Yii DAO (объекты доступа к данным)</h3>
                <h4>Выполнение SQL запросов</h4>
                <pre>$posts = Yii::$app->db->createCommand('SELECT * FROM post')
    ->queryAll();
$product = Yii::$app->db->createCommand('call product_view(:id);')
    ->bindValue(':id', $_GET['id'])
    ->queryOne();</pre>
                <h2>View</h2>
                <h3>ActiveForm</h3>
                <pre class="prettyprint lang-php">
    &lt;?php if ($model-&gt;iconsrc &amp;&amp; file_exists(Yii::getAlias('@frontend/web/', $model-&gt;iconsrc))): ?&gt;
        &lt;p&gt;Аватар: &lt;/p&gt;
        &lt;?= Html::img(Yii::getAlias('@webfrontend') . $model-&gt;iconsrc, ['class'=&gt;'img-responsive']) ?&gt;
        &lt;div class=&quot;btn-group&quot; data-toggle=&quot;buttons&quot;&gt;
            &lt;?= Html::activeCheckbox($model,'del_file',['uncheck' =&gt; null, 'label' =&gt; 'Удалить аватар', 'labelOptions' =&gt; ['class'=&gt;&quot;btn btn-primary&quot;]]) ?&gt;
        &lt;/div&gt;
    &lt;?php endif ?&gt;

    &lt;?php $form = ActiveForm::begin(['options' =&gt; ['enctype' =&gt; 'multipart/form-data']]); ?&gt;
    &lt;?= $form-&gt;field($model, 'user_id')-&gt;hiddenInput(['value'=&gt;$user-&gt;id])-&gt;label(false) ?&gt;

    &lt;?= $form-&gt;field($modelform, 'email')-&gt;textInput(['type'=&gt;'email']) ?&gt;
    &lt;?php if ($modelform-&gt;isNewRecord): ?&gt;
        &lt;?= $form-&gt;field($modelform, 'password')-&gt;passwordInput() ?&gt;
    &lt;?php endif ?&gt;
    &lt;?= $form-&gt;field($modelform, 'status')-&gt;radioList([
        USER::STATUS_DELETED =&gt; 'Удален',
        USER::STATUS_ACTIVE =&gt; 'Активен',
    ]) ?&gt;
    &lt;?= $form-&gt;field($model, 'created_at')-&gt;textInput(['placeholder' =&gt; date('Y-m-d h:i:s')]) ?&gt;
    &lt;?= $form-&gt;field($model, 'selectedKitchen')-&gt;dropDownList($kitchenList,['multiple' =&gt; 'true','size'=&gt;10]) ?&gt;
    &lt;?= $form-&gt;field($model, 'costmin')-&gt;textInput(['maxlength' =&gt; true, 'value' =&gt; is_null($model-&gt;costmin)?100:$model-&gt;costmin]) ?&gt;
    &lt;?= $form-&gt;field($model, 'callfrom')-&gt;textInput(['maxlength' =&gt; true, 'placeholder' =&gt; '0000', 'value' =&gt; is_null($model-&gt;callfrom)?'0000':$model-&gt;callfrom]) ?&gt;
    &lt;div class=&quot;form-group field-news-selectednewstag&quot;&gt;
    &lt;label class=&quot;control-label&quot; for=&quot;news-selectednewstag&quot;&gt;Теги новости&lt;/label&gt;
    &lt;div id=&quot;news-selectednewstag&quot;&gt;
        &lt;?= Html::checkboxList('News[selectedNewstag]', $newsTagAll, $newsTagAll, ['tag'=&gt;false]); ?&gt;
    &lt;!-- &lt;label&gt;&lt;input type=&quot;checkbox&quot; name=&quot;News[selectedNewstag][]&quot; value=&quot;Акцизы&quot;&gt; Акцизы&lt;/label&gt; --&gt;
    &lt;/div&gt;
    &lt;/div&gt;

    
    &lt;?= $form-&gt;field($model, 'file[]')-&gt;fileInput(['multiple' =&gt; true, 'accept' =&gt; 'image/*'])-&gt;label('Добавить фотографии') ?&gt;

    &lt;?php
    if($model-&gt;src &amp;&amp; file_exists(Yii::getAlias('@frontend/web/', $model-&gt;src)))
    {
        echo Html::tag('p', 'Изображение: ');
        echo Html::img(Yii::getAlias('@webfrontend') . $model-&gt;src, ['class'=&gt;'img-responsive']);
        // echo $form-&gt;field($model,'del_img')-&gt;checkBox(['class'=&gt;'span-1']);
    }
    ?&gt;
    &lt;?= $form-&gt;field($model, 'dishmode_id')-&gt;radioList($dishmodes) ?&gt;
    &lt;?= $form-&gt;field($model, 'dishmode_id')-&gt;radioList($dishmodes) ?&gt;

    &lt;?= $form-&gt;field($model, 'diet_id')-&gt;dropDownList($diets,['prompt' =&gt; 'Выберите вид диеты…']) ?&gt;

    &lt;?= $form-&gt;field($model, 'kitchens')-&gt;dropDownList($kitchens,['multiple' =&gt; 'true','size'=&gt;8]) ?&gt;
    &lt;?= $form-&gt;field($model, 'foto_id')-&gt;radioList(
        ArrayHelper::map($model-&gt;fotos, 'id', 'src'),
        [
            'item' =&gt; function($index, $label, $name, $checked, $value) {
                return '&lt;label style=&quot;display:inline&quot;&gt;' .
                    '&lt;input type=&quot;radio&quot; name=&quot;' . $name . '&quot; value=&quot;' . $value . '&quot;&gt;' .
                    '&lt;i&gt;&lt;/i&gt;' .
                    '&lt;span&gt;' . Html::img(Yii::getAlias('@webfrontend') . $label, []) . '&lt;/span&gt;';
                    '&lt;/label&gt;';
            },
        ]
    ) ?&gt;
</pre>
                <h3>Не ActiveForm =)</h3>
                <p>Если bad request (#400) не удалось проверить переданные данные, то наверняка забыли про CSRF</p>
                <pre class="prettyprint lang-php">
&lt;input type=&quot;hidden&quot; name=&quot;_csrf&quot; value=&quot;&lt;?=Yii::$app-&gt;request-&gt;getCsrfToken()?&gt;&quot; /&gt;
</pre>
                <p>Или отключить CSRF проверку, в контроллере</p>
                <pre class="prettyprint lang-php">
...
public $enableCsrfValidation = true;
...
// Или прям в экшене контроллера:
...
$this->enableCsrfValidation = false;
...
</pre>
                <h3>DetailView</h3>
                <pre class="prettyprint lang-php">
            'email:email',
            [
                'label' => 'Статус',
                'value' => USER::$statusName[$model->status],
            ],
            [
                'label' => 'Создан',
                'value' => date('Y-m-d h:i:s', $model->created_at),
            ],
            [
                'label' => 'Имя пользователя',
                // if code in controller: $user = $model->getUser()->asArray()->all(); // но так делать не надо:
                // 'value' => $user[0]['username'],
                // or
                'value' => $model->user->username,
            ],
            [
                'label' => 'Предпочтение к кухням',
                'value' => implode(', ',ArrayHelper::getColumn($model->user->kitchen,'header')),
            ],
            [
                'attribute'=>'Изображение',
                'value'=>Yii::getAlias('@webfrontend') . $model->imgsrc,
                'format' => ['image',['width'=>News::IMG_WIDTH,'height'=>News::IMG_HEIGHT]],
                'visible' => $model->imgsrc? true:false,
            ],
            [
                'attribute'=>'Фотография',
                'value'=>Yii::getAlias('@webfrontend') . $model->src,
                'format' => ['image',],
                'visible' => $model->src? true:false,
            ],
            [
                'label' =&gt; 'Диета',
                // 'value' =&gt; $model-&gt;diet-&gt;header,
                'value' =&gt; $model-&gt;diet? $model-&gt;diet-&gt;header : Html::encode('&lt;span class=&quot;not-set&quot;&gt;(не задано)&lt;/span&gt;'),
            ],
            [
                'label' => 'Фотографии альбома ' . 
                    Html::a('Добавить фотографии', ['foto/createfotos', 'id' => $model->id], ['class' => 'btn btn-success btn-xs']),
                'value' => $model->listImg,
                'format' => 'raw'
            ],

</pre>
                <h3>GridView</h3>
                <pre class="prettyprint lang-php">
            'product.header',
            'product.price',
            'product.pricesale',
            'product.time',
            // 'user.username',
            [
                'label' => 'Имя пользователя',
                'value' => 'user.username',
                'attribute' => 'user_name',
            ],
            // 'user.username',
            [
                'label' => 'Имя пользователя',
                'attribute'=>'username',
                'value' => function($data)
                {
                    return $data->user->username;
                }
            ],
            'email:email',
            [
                'attribute'=>'status',
                'value' => function($data)
                {
                    return User::$statusName[$data->status];
                }
            ],

            [
                'attribute'=>'created_at',
                'value'=>function($data)
                {
                    return date('Y-m-d h:i:s', $data->created_at);
                },
            ],
            [
                'format' => 'image',
                'label' => '80x80',
                'value' => function($data) { return Yii::getAlias('@webfrontend') . $data->src80; },
            ],
</pre>
                <h4>Добавление фильтра</h4>
                <h5>Фильтр новостей по тегам</h5>
                <p>Необходим список всех тегов. В контроллере получим и передадим во вьюху</p>
                <pre class="prettyprint lang-php">
        $tags = ArrayHelper::map(NewsTag::find()->all(), 'id' ,'header');
</pre>
                <p>Во вьюхе укажим фильтр <code>'filter' => $tags,</code>, ну и вывод <code>'format' => 'raw',</code> и т.д.</p>
                <pre class="prettyprint lang-php">
            [
                'attribute'=>'tag',
                'label' => 'Теги',
                'value' => function($data) {
                    if (count($data->newsTag)) {
                        $return = [];
                        foreach ($data->newsTag as $newsTag) {
                            $return[] = $newsTag->header;
                        }
                        return implode(' ', $return);
                    } else {
                        return null;
                    }
                },
                'format' => 'raw',
                'filter' => $tags,
            ],
</pre>
                <p>Главное в ModelSearch.php</p>
                <p>Создать переменную</p>
                <pre class="prettyprint lang-php">
    public $tag;
</pre>
                <p>Добавить в рулес</p>
                <pre class="prettyprint lang-php">
            ['tag', 'safe'],
</pre>
                <p>Отредактировать запрос поиска добавив связанную таблицу</p>
                <pre class="prettyprint lang-php">
        $query->joinWith(['newsTag']);
</pre>
                <p>Указать условия сортировки по данному полю</p>
                <pre class="prettyprint lang-php">
        $dataProvider->sort->attributes['tag'] = [
            'asc' => ['news_tag.header' => SORT_ASC],
            'desc' => ['news_tag.header' => SORT_DESC],
        ];
</pre>
                <p>Добавим фильтр по полю так (не как like, а как по id)</p>
                <pre class="prettyprint lang-php">
            'news_tag.id' => $this->tag,
</pre>
                <h3>Assets</h3>
                <p>Model</p>
                <pre class="prettyprint lang-php">
namespace frontend\assets;

use yii\web\AssetBundle;

/**
 * @author Qiang Xue <qiang.xue@gmail.com>
 * @since 2.0
 */
class AppAsset extends AssetBundle
{
    public $basePath = '@webroot';
    public $baseUrl = '@web';
    public $css = [
        // 'css/site.css',
    ];
    public $js = [
    ];
    public $depends = [
        // 'yii\web\YiiAsset',
        // 'yii\bootstrap\BootstrapAsset',
    ];
}
</pre>
                <p>In view</p>
                <pre class="prettyprint lang-php">
use frontend\assets\MainAsset;
MainAsset::register($this);
</pre>
                <p>Register JS or CSS file depend Asset (in view):</p>
                <pre class="prettyprint lang-php">
use frontend\assets\MainAsset;
$this-&gt;registerJsFile('/js/favoriteKitchen.js', ['depends' =&gt; [MainAsset::className()]]);
</pre>
                <h2>Access</h2>
                <h3>Аутентификация</h3>
                <p>Настройка</p>
                <pre class="prettyprint lang-php">
return [
    'components' => [
        'user' => [
            'identityClass' => 'app\models\User',
            'enableAutoLogin' => true,
            // 'loginUrl' => ['site/login'],
        ],
    ],
];
</pre>
                <p>Определение</p>
                <pre class="prettyprint lang-php">
// `identity` текущего пользователя. `Null`, если пользователь не аутентифицирован.
$identity = Yii::$app->user->identity;

// ID текущего пользователя. `Null`, если пользователь не аутентифицирован.
$id = Yii::$app->user->id;

// проверка на то, что текущий пользователь гость (не аутентифицирован)
$isGuest = Yii::$app->user->isGuest;
</pre>
                <p>Для залогинивания пользователя вы можете использовать следующий код:</p>
                <pre class="prettyprint lang-php">
// найти identity с указанным username.
// замечание: также вы можете проверить и пароль, если это нужно
$identity = User::findOne(['username' => $username]);

// логиним пользователя
Yii::$app->user->login($identity);
</pre>
                <p>Для выхода пользователя, просто вызовите</p>
                <pre class="prettyprint lang-php">
Yii::$app->user->logout();
</pre>
                <h3>AccessControl</h3>
                <p>Если достаточно только ролей, то можно обойтись без RBAC, используя matchCallback в AccessControl, например: "Если пользователь залогинен и являетсмя админом" :</p>
                <pre class="prettyprint lang-php">
    public function behaviors()
    {
        return [
            'access' => [
                'class' => AccessControl::className(),
                'only' => ['view'],
                // Или
                // 'except' => ['view'],
                'rules' => [
                    [
                        'actions' => ['view'],
                        'allow' => true,
                        'roles' => ['@'],
                        'matchCallback' => function ($rule, $action) {
                            return User::isUserAdmin(Yii::$app->user->identity->username);
                            // Или
                            //return Yii::$app->user->identity->admin;
                            // Или
                            //return Yii::$app->user->identity->role === User::ROLE_USER;
                        }
                    ],
                ],
            ],
        ];
    }
</pre>
                <h3>RBAC (AuthManager)</h3>
                <h4>Подключение (настройка)</h4>
                <p>- это компонент, задаем в конфиге:</p>
                <pre class="prettyprint lang-php">
    'components' => [
        ...
        'user' => [
            'identityClass' => 'common\models\User',
            'enableAutoLogin' => true,
            // 'loginUrl' => ['site/login'],
        ],
        'authManager' => [
            'class' => 'yii\rbac\PhpManager',
            // 'defaultRoles' => ['guest'],
        ],
        'urlManager' => [
            'enablePrettyUrl' => true,
        ...
</pre>
                <p>Компонент может быть зада классом yii\rbac\PhpManager или yii\rbac\DbManager (хранить в файле или бд)</p>
                <p>Главный метод checkAccess</p>
                <h4>Добавление PhpManager</h4>
                <p>authManager настройка frontend/config/main.php :</p>
                <pre class="prettyprint lang-php">
        'authManager' => [
            'class' => 'yii\rbac\PhpManager',
            // 'defaultRoles' => ['guest'],
            'itemFile' => '@frontend/components/rbac/items.php',
            'assignmentFile' => '@frontend/components/rbac/assignments.php',
            'ruleFile' => '@frontend/components/rbac/rules.php',
        ],
</pre>
                <p>Соответственно создал папку @frontend/components/rbac/</p>
                <p>настройка для работы с консолью console/config/main.php :</p>
                <pre class="prettyprint lang-php">
        'authManager' => [
            'class' => 'yii\rbac\PhpManager',
            // 'defaultRoles' => ['guest'],
            'itemFile' => '@frontend/components/rbac/items.php',
            'assignmentFile' => '@frontend/components/rbac/assignments.php',
            'ruleFile' => '@frontend/components/rbac/rules.php',
        ],
        'user' => [
            'class' => 'yii\web\User',
            'identityClass' => 'common\models\User',
            'enableAutoLogin' => false,
            'enableSession' => false,
        ],
</pre>
                <p>Создали контроллер для консоли:</p>
                <pre class="prettyprint lang-php">
&lt;?php
namespace console\controllers;

use Yii;
// use \yii\web\User;
use common\models\User;
use \yii\console\Controller;
use \yii\helpers\ArrayHelper;

class RbacController extends Controller
{

    public function actionInit()
    {
        $auth = Yii::$app-&gt;getAuthManager();
        $auth-&gt;removeAll();

        $user = $auth-&gt;createRole('user');
        $auth-&gt;add($user);

        $admin = $auth-&gt;createRole('admin');
        $auth-&gt;add($admin);

        $auth-&gt;addChild($admin,$user);

        $this-&gt;stdout('Done' . PHP_EOL);
    }

}
</pre>
                <p>Запускаем команду <code>php yii rbac/init</code> - получаем три файла там где и ожидали.</p>
                <h4>Тестирование</h4>
                <p>создаем пользователя, логиним, разлогиним (В консольном контроллере создаем actionTest)</p>
                <pre class="prettyprint lang-php">
    public function actionTest()
    {
        Yii::$app->set('request', new \yii\web\Request());

        $user = new User(['id' => 1, 'username' => 'Username']);
        // $user = new User();
        // $user->id = 1;
        // $user->username = 'Username';

        var_dump(Yii::$app->user->id);
        var_dump(Yii::$app->user->identity);

        Yii::$app->user->login($user);
        
        var_dump(Yii::$app->user);
        var_dump(Yii::$app->user->identity);
        // var_dump(Yii::$app->user->id);
        // var_dump(Yii::$app->user->identity->id);

        Yii::$app->user->logout();

        var_dump(Yii::$app->user->id);
        var_dump(Yii::$app->user->identity);
    }
</pre>
                <p>Создаем пользователя, удаляем все роли, привязываем роли, выводим роли</p>
                <pre class="prettyprint lang-php">
    public function actionTest()
    {
        Yii::$app->set('request', new \yii\web\Request());

        $user = new User(['id' => 1, 'username' => 'Username']);
        $auth = Yii::$app->getAuthManager();

        $auth->revokeAll($user->id);

        echo 'Roles for user ' . PHP_EOL;
        print_r($auth->getRolesByUser($user->id));

        $auth->assign($auth->getRole('user'),$user->id);
        $auth->assign($auth->getRole('admin'),$user->id);

        echo 'New Roles for user ' . PHP_EOL;
        print_r($auth->getRolesByUser($user->id));

        echo 'New Roles for user ' . PHP_EOL;
        print_r(implode(', ', ArrayHelper::map($auth->getRolesByUser($user->id), 'name', 'name')));

        echo PHP_EOL;
    }
</pre>
                <p>Логинимся пользователем и проверяем, обратить внимание на метод проверки can()</p>
                <pre class="prettyprint lang-php">
    public function actionTest()
    {
        Yii::$app->set('request', new \yii\web\Request());

        $user = new User(['id' => 1, 'username' => 'Username']);

        Yii::$app->user->login($user);

        var_dump(Yii::$app->user->can('admin'));
        // Или // Но тогда это не кешируется, а ->can() - кешируется
        // var_dump(Yii::$app->authManager->checkAccess($user->id,'admin'));

        echo PHP_EOL;
    }
</pre>
                <h4>Работаем разрешениями и прикрепленным к ним правилам</h4>
                <pre class="prettyprint lang-php">
    public function actionInit()
    {
        $auth = Yii::$app->getAuthManager();
        // Удаляем роли (и разрешения) и правила
        $auth->removeAll();

        // Создаем роли
        $user = $auth->createRole('user');
        $auth->add($user);

        $admin = $auth->createRole('admin');
        $auth->add($admin);

        // Роль admin - наследник
        $auth->addChild($admin, $user);

        // Создаем разрешения
        $createPublication = $auth->createPermission('Создать публикацию');
        $createPublication->description = 'Создать публикацию';
        $auth->add($createPublication);

        $updatePublication = $auth->createPermission('Редактировать публикацию');
        $updatePublication->description = 'Редактировать публикацию';
        $auth->add($updatePublication);

        // Создаем правило
        $updateOwnPublicationRule = new \frontend\components\rbac\rules\UpdateOwnPublicationRule();
        $auth->add($updateOwnPublicationRule);

        // Создаем разрешение
        $updateOwnPublication = $auth->createPermission('Редактировать свою публикацию');
        $updateOwnPublication->description = 'Редактировать свою публикацию';
        // Добавляем правило к разрешению
        $updateOwnPublication->ruleName = $updateOwnPublicationRule->name;
        $auth->add($updateOwnPublication);

        $auth->addChild($updateOwnPublication, $updatePublication);

        $auth->addChild($user, $createPublication);
        $auth->addChild($user, $updateOwnPublication);

        $auth->addChild($admin, $updatePublication);


        $this->stdout('Done' . PHP_EOL);
    }

    public function actionTest()
    {
        Yii::$app->set('request', new \yii\web\Request());
        $auth = Yii::$app->getAuthManager();
        
        $user = new User(['id' => 1, 'username' => 'Username']);
        $admin = new User(['id' => 2, 'username' => 'Adminname']);

        $auth->revokeAll($user->id);
        $auth->revokeAll($admin->id);

        $auth->assign($auth->getRole('user'),$user->id);
        $auth->assign($auth->getRole('admin'),$admin->id);

        // ############################################
        
        $publication = new Publication([
            'header' => 'header',
            'sid' => 'sid',
            'user_id' => $user->id,
        ]);

        $publication2 = new Publication([
            'header' => 'header2',
            'sid' => 'sid2',
            'user_id' => $admin->id,
        ]);

        // ############################################

        $this->stdout('Проверка разрешений для ' . $user->username . ' и первой публикации' . PHP_EOL, Console::FG_BLUE);
        Yii::$app->user->login($user);

        $this->stdout('Создание публикации ' . (string)Yii::$app->user->can('Создать публикацию') . PHP_EOL, Console::FG_GREEN);
        $this->stdout('Редактирование публикации ' . (string)Yii::$app->user->can('Редактировать публикацию', [
            'publication' => $publication,
        ]) . PHP_EOL, Console::FG_GREEN);
        $this->stdout('Редактирование своей публикации ' . (string)Yii::$app->user->can('Редактировать свою публикацию', [
            'publication' => $publication,
        ]) . PHP_EOL, Console::FG_GREEN);

        // ############################################

        $this->stdout('Проверка разрешений для ' . $admin->username . ' и первой публикации' . PHP_EOL, Console::FG_BLUE);
        Yii::$app->user->login($admin);

        $this->stdout('Создание публикации ' . (string)Yii::$app->user->can('Создать публикацию') . PHP_EOL, Console::FG_GREEN);
        $this->stdout('Редактирование публикации ' . (string)Yii::$app->user->can('Редактировать публикацию', [
            'publication' => $publication,
        ]) . PHP_EOL, Console::FG_GREEN);
        $this->stdout('Редактирование своей публикации ' . (string)Yii::$app->user->can('Редактировать свою публикацию', [
            'publication' => $publication,
        ]) . PHP_EOL, Console::FG_GREEN);

        // ############################################

        $this->stdout('Проверка разрешений для ' . $user->username . ' и второй публикации' . PHP_EOL, Console::FG_BLUE);
        Yii::$app->user->login($user);

        $this->stdout('Создание публикации ' . (string)Yii::$app->user->can('Создать публикацию') . PHP_EOL, Console::FG_GREEN);
        $this->stdout('Редактирование публикации ' . (string)Yii::$app->user->can('Редактировать публикацию', [
            'publication' => $publication2,
        ]) . PHP_EOL, Console::FG_GREEN);
        $this->stdout('Редактирование своей публикации ' . (string)Yii::$app->user->can('Редактировать свою публикацию', [
            'publication' => $publication2,
        ]) . PHP_EOL, Console::FG_GREEN);

        // ############################################

        $this->stdout('Проверка разрешений для ' . $admin->username . ' и второй публикации' . PHP_EOL, Console::FG_BLUE);
        Yii::$app->user->login($admin);

        $this->stdout('Создание публикации ' . (string)Yii::$app->user->can('Создать публикацию') . PHP_EOL, Console::FG_GREEN);
        $this->stdout('Редактирование публикации ' . (string)Yii::$app->user->can('Редактировать публикацию', [
            'publication' => $publication2,
        ]) . PHP_EOL, Console::FG_GREEN);
        $this->stdout('Редактирование своей публикации ' . (string)Yii::$app->user->can('Редактировать свою публикацию', [
            'publication' => $publication2,
        ]) . PHP_EOL, Console::FG_GREEN);

    }

</pre>
                <p>Должно вывести это:</p>
                <pre>
Проверка разрешений для Username и первой публикации
Создание публикации 1
Редактирование публикации 1
Редактирование своей публикации 1
Проверка разрешений для Adminname и первой публикации
Создание публикации 1
Редактирование публикации 1
Редактирование своей публикации 
Проверка разрешений для Username и второй публикации
Создание публикации 1
Редактирование публикации 
Редактирование своей публикации 
Проверка разрешений для Adminname и второй публикации
Создание публикации 1
Редактирование публикации 1
Редактирование своей публикации 1
</pre>
                <h4>Проверить алгоритм</h4>
                <p>можно залезть в vendor/yii.../rbac/PhpManager.php@checkAccessRecursive(..., $i = 1) {}. Добавить первой строкой: echo str_repeat('&gt; ',$i) . $itemName . PHP_EOL; И </p>
                <h4>На живом примере</h4>
                <p>В контроллере новостей</p>
                <pre class="prettyprint lang-php">
use yii\web\ForbiddenHttpException;

....

        if (!Yii::$app->user->can('Просмотреть новость')) {
            throw new ForbiddenHttpException();
        }
</pre>
                <h2>Pjax</h2>
                <h3>Параметры</h3>
                <h4>enablePushState</h4>
                <p>Параметр enablePushState = true - получим изменение адреса в адресной строке браузера.</p>
                <pre class="prettyprint lang-php">
&lt;?php
use yii\widgets\Pjax;
?&gt;
&lt;?= $this-&gt;render('_profile', ['model' =&gt; $model]) ?&gt;
&lt;?php Pjax::begin(['enablePushState' =&gt; false]); ?&gt;
    &lt;?= $this-&gt;render('_addresses', ['model' =&gt; $model]) ?&gt;
&lt;?php Pjax::end(); ?&gt;
</pre>
                <h2>Errors</h2>
                <h3>The use statement with non-compound name 'Yii' has no effect</h3>
                <p>Эта ошибка возникает если в глобальном неймспейсе использовать <code>use Yii;</code> - глобальный неймспейс.</p>
                <p>Ошибка наиболее распространена во вьюхах (они в глобале), а я по привычке там фигачу <code>use Yii;</code></p>
            </div>
        </div>
    </div>
    <!-- jQuery -->
    <script src="//code.jquery.com/jquery.js"></script>
    <!-- Bootstrap JavaScript -->
    <script type="text/javascript" src="../theme/bootstrap/js/bootstrap.min.js"></script>
    <!-- Подсветка синтаксиса кода -->
    <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>
    <!-- TOC -->
    <script src="../theme/toc/js/js.js" type="text/javascript"></script>
</body>

</html>
