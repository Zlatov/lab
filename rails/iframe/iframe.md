<!-- https://www.dev-notes.ru/articles/security/csrf-bypassing-samesite-restrictions/ -->

# Корректное отображение сайта в iframe

Чтобы сайт мог отображаться в iframe, и так же использовал сессионные данные в
coockie для его верного отображения необходимо:

1.  В http заголовках параметр `X-Frame-Options` не должен быть выставлен в `sameorigin`. Ошибка:

    ```js
    // Отказался отображать «https://.../» во фрейме, поскольку для
    // параметра «X-Frame-Options» установлено значение «sameorigin».
    ```

    Решение для отдельной страницы:

    ```rb
    after_action :allow_iframe, only: :some_action

    def some_action
    end

    private

    def allow_iframe
      response.headers.except! 'X-Frame-Options'
    end
    ```

    Возможные значения параметра `X-Frame-Options`:

    `DENY` - Страница не может отображаться во фрейме, независимо от того, какой
    сайт пытается это сделать.

    `SAMEORIGIN` - Страница может отображаться только в том случае, если все
    исходные кадры имеют то же происхождение, что и сама страница.

    Отсутствие заголовка - разрешает отображение.

    `ALLOW-FROM origin` - Устарело. Это устаревшая директива. Современные
    браузеры, встречающие заголовки ответов с этой директивой, полностью
    игнорируют заголовок. В Content-Security-Policy заголовке HTTP есть
    frame-ancestors директива, которую вам следует использовать вместо этого.

2.  Для того чтобы куки передались серверу при работе в iframe, необходимо что
    бы у них (кук) было выставлено разрешающее значение у параметра SameSite:

    `None`

    Если cookie установлен с атрибутом SameSite=None, то это фактически
    полностью отключает ограничения SameSite, независимо от браузера. В
    результате браузеры будут отправлять этот cookie во всех запросах к
    выдавшему его сайту, даже в тех, которые были вызваны совершенно
    несвязанными с ним сторонними сайтами.

    За исключением Chrome, это поведение по умолчанию, используемое основными
    браузерами, если при установке cookie не указан атрибут SameSite.

    Существуют обоснованные причины для отключения SameSite, например, когда
    файл cookie предназначен для использования в стороннем контексте и не
    предоставляет его носителю доступ к каким-либо конфиденциальным данным или
    функциональным возможностям. Типичным примером являются отслеживающие файлы
    cookie.

    Если вы встретили файл cookie, установленный с параметром SameSite=None или
    без явных ограничений, стоит выяснить, насколько он полезен. Когда
    поведение Lax-by-default было впервые применено в Chrome, это привело к
    поломке многих существующих веб-функций. В качестве быстрого обходного пути
    некоторые сайты решили просто отключить ограничения SameSite для всех
    файлов cookie, включая потенциально важные.

    При установке cookie с параметром SameSite=None веб-сайт должен также
    включать атрибут Secure, который гарантирует, что cookie будет отправляться
    только в зашифрованных сообщениях по протоколу HTTPS. В противном случае
    браузеры будут отклонять cookie, и он не будет установлен.

    `Strict`

    Если cookie установлен с атрибутом SameSite=Strict, браузеры не будут
    отправлять его при межсайтовых запросах. Проще говоря, это означает, что
    если целевой сайт запроса не совпадает с сайтом, отображаемым в данный
    момент в адресной строке браузера, то cookie не будет включён.

    Это рекомендуется делать при установке cookies, позволяющих пользователю
    изменять данные или выполнять другие конфиденциальные действия, например,
    получать доступ к определённым страницам, которые доступны только
    аутентифицированным пользователям.

    Хотя этот вариант является наиболее безопасным, он может негативно сказаться
    на пользовательском опыте в тех случаях, когда желательна межсайтовая
    функциональность.

    `Lax`

    Ограничения Lax SameSite означают, что браузеры будут отправлять cookie при
    межсайтовых запросах, но только если выполняются оба следующих условия:

    1.  В запросе используется метод GET.
    2.  Запрос является результатом навигации пользователя по верхнему уровню, например, перехода по ссылке.

    Это означает, что cookie не включается, например, в межсайтовые POST
    запросы. Поскольку POST запросы обычно используются для выполнения
    действий, изменяющих данные или состояние (по крайней мере, согласно лучшим
    практикам), они с гораздо большей вероятностью могут стать целью
    CSRF-атак.

    Аналогичным образом cookie не включается в фоновые запросы, например,
    инициируемые скриптами, iframe или ссылками на изображения и другие
    ресурсы.

    Решение в rails 7:

    ```rb
    # config/environments/development.rb
    config.force_ssl = true
    config.action_dispatch.cookies_same_site_protection = :none
    # или
    config.action_dispatch.cookies_same_site_protection = ->(request) do
      print 'request.url: '.red; puts request.url
      # :strict unless request.user_agent == "TestAgent"
      # print 'User.first.email: '.red; puts User.first.email
      if request.url == 'https://domain.local/some_page'
        :none
      else
        # :strict
        # nil
        :lax
      end
    end
    ```
