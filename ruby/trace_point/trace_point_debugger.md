# TracePoint

Встроенный в Ruby инструмент для отслеживания событий выполнения программы. Он
позволяет перехватывать такие события, как вызовы методов, создание классов,
исключения, выполнение блоков и многое другое.

TracePoint — это часть стандартной библиотеки Ruby. Он работает на уровне
виртуальной машины Ruby (MRI) и даёт доступ к информации о том, что происходит
внутри программы в реальном времени.

## Как работает

Мы создаём объект:

```ruby
TracePoint.new(:call) do |tp|
  puts "#{tp.defined_class}##{tp.method_id}"
  puts caller
end
```

*   `:call` — событие «вызов метода» (есть также :return, :raise, :line, :class, :end и другие)
*   блок получает объект `tp`, в котором есть информация о событии
*   можно вывести стек вызовов (`caller`) или анализировать tp.defined_class, tp.method_id, tp.lineno и т.д.

## Управление

После создания объект *не активен*, пока вы не включите его:

```ruby
tp.enable   # начинает ловить события
tp.disable  # прекращает
```

Можно включать и выключать в любой момент, что позволяет адресно исследовать поведение кода.

## Зачем нужен

TracePoint идеален когда нужно понять:

*   какие методы вызываются
*   в каком порядке
*   что вызывает сторонние библиотеки (CarrierWave, ActiveRecord и т.п.)
*   почему происходит неожиданное поведение
*   какие callbacks срабатывают

Это «рентген» Ruby-приложения — показывает всю скрытую активность внутри.

## Примеры

```ruby
# В консоли rails:
tp = TracePoint.new(:call) do |tp|
  if tp.defined_class.to_s.include?("CarrierWave")
    puts "#{tp.defined_class}##{tp.method_id}"
    puts caller.take(10).join("\n")
    puts "---"
  end
end

tp.enable
product.save!
tp.disable
```
